version: '2.1'

volumes:
  db:
  registry:
  # FIXME: remove
  img:

services:
  api:
    extends:
      file: ./common.yml
      service: component
    image: resin/resin-api:${OPENBALENA_API_VERSION_TAG:-master}
    depends_on:
      - db
    security_opt:
      - seccomp:unconfined
    environment:
      ADMIN_LIST: 
      AUTH_RESINOS_REGISTRY_CODE: ${OPENBALENA_RESINOS_REGISTRY_CODE}
      BALENA_ROOT_CA: ${OPENBALENA_ROOT_CA}
      DB_HOST: db
      DB_PASSWORD: docker
      DB_PORT: 5432
      DB_USER: docker
      DEBUG: '${OPENBALENA_DEBUG}'
      DEVICE_CONFIG_OPENVPN_CA: yyy
      DEVICE_CONFIG_OPENVPN_CONFIG: yyy
      DEVICE_CONFIG_SSH_AUTHORIZED_KEYS: yyy
      EMAIL_RECIPIENT_OVERRIDE: 
      HOST: ${OPENBALENA_HOST_NAME}
      IMAGE_MAKER_URL: img.${OPENBALENA_HOST_NAME}
      JSON_WEB_TOKEN_EXPIRY_MINUTES: 10080
      JSON_WEB_TOKEN_SECRET: ${OPENBALENA_JWT_SECRET}
      PRODUCTION_MODE: '${OPENBALENA_PRODUCTION_MODE}'
      REGISTRY2_HOST: registry.${OPENBALENA_HOST_NAME}
      TOKEN_AUTH_CERT_ISSUER: api.${OPENBALENA_HOST_NAME}
      TOKEN_AUTH_CERT_KEY: ${OPENBALENA_TOKEN_AUTH_KEY}
      TOKEN_AUTH_CERT_KID: ${OPENBALENA_TOKEN_AUTH_KID}
      TOKEN_AUTH_CERT_PUB: ${OPENBALENA_TOKEN_AUTH_PUB}
      TOKEN_AUTH_JWT_ALGO: 'ES256'
      VPN_HOST: vpn.${OPENBALENA_HOST_NAME}
      VPN_PORT: 443
      VPN_SERVICE_API_KEY: ${OPENBALENA_VPN_SERVICE_API_KEY}
      # FIXME: remove all the following
      ADMIN_HOST: __unused__
      AUTH_FACEBOOK_CLIENT_ID: __unused__
      AUTH_FACEBOOK_CLIENT_SECRET: __unused__
      AUTH_GITHUB_CLIENT_ID: __unused__
      AUTH_GITHUB_CLIENT_SECRET: __unused__
      AUTH_GOOGLE_CLIENT_ID: __unused__
      AUTH_GOOGLE_CLIENT_SECRET: __unused__
      AUTH_TWITTER_CONSUMER_KEY: __unused__
      AUTH_TWITTER_CONSUMER_SECRET: __unused__
      BUILDER_SERVICE_API_KEY: __unused__1 # must be unique
      COOKIE_SESSION_SECRET: __unused__
      DB_ANALYTICS_PASSWORD: 
      DELTA_HOST: __unused__
      DELTA_SERVICE_API_KEY: __unused__2 # must be unique
      DEVICE_URLS_BASE: __unused__
      DIGITIZER_API_KEY: __unused__3 # must be unique
      GA_ID: __unused__
      GA_SITE: __unused__
      GEOIP_LICENCE_KEY: __unused__
      GEOIP_USER_ID: __unused__
      GIT_HOST: __unused__
      GIT_HOSTNAME: __unused__
      GIT_PORT: 80
      GIT_SERVICE_API_KEY: __unused__4 # must be unique
      INTERCOM_APP_ID: __unused__
      INTERCOM_SECRET_KEY: __unused__
      MAILGUN_API_KEY: __unused__
      MAILGUN_DOMAIN: __unused__
      MIXPANEL_ACCOUNT_ID: __unused__
      MIXPANEL_API_KEY: __unused__
      MIXPANEL_API_SECRET: __unused__
      MIXPANEL_TOKEN: __unused__
      PROXY_SERVICE_API_KEY: __unused__5 # must be unique
      PUBNUB_PUBLISH_KEY: __unused__
      PUBNUB_SUBSCRIBE_KEY: __unused__
      RECAPTCHA_PRIVATE_KEY: __unused__
      RECAPTCHA_PUBLIC_KEY: __unused__
      RECURLY_PRIVATE_KEY: __unused__
      RECURLY_PUBLIC_KEY: __unused__
      RECURLY_SUBDOMAIN: __unused__
      REDIS_HOST: __unused__
      REDIS_PORT: 6379
      REGISTRY_HOST: __unused__
      SENTRY_DSN: 
      TOKEN_AUTH_BUILDER_TOKEN: __unused__
      TWOFACTOR_ISSUER: __unused__
      UI_HOST: __unused__
      ZENDESK_DOMAIN: __unused__
      ZENDESK_SHARED_SECRET: __unused__

  registry:
    extends:
      file: ./common.yml
      service: component
    image: resin/open-balena-registry:${OPENBALENA_REGISTRY_VERSION_TAG:-master}
    depends_on:
      - api
    volumes:
      - registry:/data
    environment:
      API_TOKENAUTH_CRT: ${OPENBALENA_TOKEN_AUTH_PUB}
      BALENA_ROOT_CA: ${OPENBALENA_ROOT_CA}
      COMMON_REGION: 
      REGISTRY2_HOST: registry.${OPENBALENA_HOST_NAME}
      REGISTRY2_S3_BUCKET: 
      REGISTRY2_S3_KEY: 
      REGISTRY2_S3_SECRET: 
      REGISTRY2_STORAGEPATH: /data
      TOKENAUTH_ISSUER: api.${OPENBALENA_HOST_NAME}
      TOKENAUTH_REALM: https://api.${OPENBALENA_HOST_NAME}/auth/v1/token
      # FIXME: remove the following
      REGISTRY2_SECRETKEY: __unused__

  vpn:
    extends:
      file: ./common.yml
      service: component
    image: resin/resin-vpn:${OPENBALENA_VPN_VERSION_TAG:-master}
    depends_on:
      - api
    cap_add:
      - NET_ADMIN
    environment:
      BALENA_ROOT_CA: ${OPENBALENA_ROOT_CA}
      BALENA_VPN_PORT: 443
      LOGENTRIES_TOKEN: 
      PRODUCTION_MODE: '${OPENBALENA_PRODUCTION_MODE}'
      RESIN_API_HOST: api.${OPENBALENA_HOST_NAME}
      RESIN_VPN_GATEWAY: 10.2.0.1
      SENTRY_DSN: 
      VPN_HAPROXY_USEPROXYPROTOCOL: 'true'
      VPN_SERVICE_API_KEY: ${OPENBALENA_VPN_SERVICE_API_KEY}
      # FIXME: remove all of the following
      API_SERVICE_API_KEY: __unused__
      PROXY_SERVICE_API_KEY: __unused__5

  db:
    extends:
      file: ./common.yml
      service: system
    image: resin/open-balena-db:${OPENBALENA_DB_VERSION_TAG:-master}
    volumes:
      - db:/var/lib/postgresql/data

  haproxy:
    extends:
      file: ./common.yml
      service: system
    build: ../haproxy
    depends_on:
      - api
      - registry
      - vpn
      - db
      # FIXME: remove
      - proxy
      - img
    ports:
      - "80:80"
      - "222:222"
      - "443:443"
      - "5432:5432"
    environment:
      BALENA_ROOT_CA: ${OPENBALENA_ROOT_CA}
      HAPROXY_HOSTNAME: ${OPENBALENA_HOST_NAME}

# FIXME: remove the following

  proxy:
    extends:
      file: ./common.yml
      service: component
    image: resin/resin-proxy:${OPENBALENA_PROXY_VERSION_TAG:-master}
    depends_on:
      - api
      - vpn
    environment:
      BALENA_ROOT_CA: ${OPENBALENA_ROOT_CA}
      DEBUG: '${OPENBALENA_DEBUG}'
      DEVICE_URLS_BASE: devices.${OPENBALENA_HOST_NAME}
      IDLE_CONNECTION_TIMEOUT: 50
      JSON_WEB_TOKEN_SECRET: ${OPENBALENA_JWT_SECRET}
      LOGENTRIES_TOKEN: 
      PRODUCTION_MODE: '${OPENBALENA_PRODUCTION_MODE}'
      PROXY_PROTOCOL_PORTS: 
      PROXY_SERVICE_API_KEY: __unused__5
      RESIN_API_HOST: api.${OPENBALENA_HOST_NAME}
      SENTRY_DSN: 

  img:
    extends:
      file: ./common.yml
      service: component
    image: resin/resin-img:${OPENBALENA_IMG_VERSION_TAG:-master}
    depends_on:
      - api
    volumes:
      - img:/prepdir
    environment:
      BALENA_ROOT_CA: ${OPENBALENA_ROOT_CA}
      DEVELOPMENT: 1
      LKL_MEMORY: 268435456
      LOGENTRIES_TOKEN: 
      NODEPING_KEY: xxx
      RESIN_IMG_S3_ACCESS_KEY: abcdef1234
      RESIN_IMG_S3_BUCKET: resin-image-maker
      RESIN_IMG_S3_ENDPOINT: s3.${OPENBALENA_HOST_NAME}
      RESIN_IMG_S3_FORCE_PATH_STYLE: 'true'
      RESIN_IMG_S3_SECRET_KEY: 1234567890
      RESIN_IMG_STORAGE_DRIVER: passthrough
      SENTRY_DSN: 
